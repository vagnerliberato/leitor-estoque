<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner EAN-13 Pro</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 15px; text-align: center; background-color: #f4f6f9; color: #333; }
        
        #reader { width: 100%; max-width: 500px; margin: 0 auto; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: #000; }
        
        /* Controles e Bot√µes */
        .controls-wrapper { max-width: 500px; margin: 15px auto; }

        .btn-group { display: flex; gap: 8px; margin-bottom: 10px; }
        
        .btn { padding: 12px; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; flex: 1; transition: transform 0.1s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .btn:active { transform: scale(0.96); }
        
        .btn-start { background-color: #28a745; }
        .btn-stop { background-color: #6c757d; }
        .btn-csv { background-color: #007bff; }
        .btn-clear { background-color: #dc3545; } 

        /* Seletor de Foco */
        .focus-control { margin-bottom: 15px; background: white; padding: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .focus-select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; width: 60%; font-size: 14px; }

        /* Estat√≠sticas */
        .stats { display: flex; justify-content: space-around; max-width: 500px; margin: 15px auto; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .stat-item { display: flex; flex-direction: column; }
        .stat-label { font-size: 11px; text-transform: uppercase; color: #888; }
        .stat-value { font-size: 24px; font-weight: 800; color: #2c3e50; }

        /* Lista */
        #result-list { list-style: none; padding: 0; margin-top: 20px; max-width: 500px; margin: 0 auto; text-align: left; }
        
        .item-row { background: white; border-bottom: 1px solid #f0f0f0; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        .updated { animation: flashGreen 0.8s; }
        @keyframes flashGreen { 0% { background-color: #d4edda; } 100% { background-color: white; } }
        
        .code-text { font-weight: bold; font-size: 16px; display: block; }
        .code-time { font-size: 12px; color: #999; }
        .qty-badge { background-color: #eef2f7; color: #007bff; padding: 6px 14px; border-radius: 20px; font-weight: 800; }
    </style>
</head>
<body>

    <h3>üì¶ Scanner EAN-13</h3>
    
    <div id="reader"></div>
    
    <div class="controls-wrapper">
        <div class="focus-control" id="focus-panel" style="display:none;">
            <label for="focusMode"><strong>Modo de Foco:</strong></label>
            <select id="focusMode" class="focus-select" onchange="mudarFoco()">
                <option value="continuous">Cont√≠nuo (Autom√°tico)</option>
                <option value="single-shot">Foco √önico</option>
                <option value="macro">Macro (Perto)</option>
            </select>
        </div>

        <div class="stats">
            <div class="stat-item"><span class="stat-label">Produtos</span><span class="stat-value" id="count-unique">0</span></div>
            <div class="stat-item"><span class="stat-label">Volumes</span><span class="stat-value" id="count-total">0</span></div>
        </div>

        <div class="btn-group">
            <button id="start-btn" class="btn btn-start">üì∑ Iniciar</button>
            <button id="stop-btn" class="btn btn-stop" style="display:none;">‚èπ Parar</button>
        </div>
        <div class="btn-group">
            <button onclick="baixarCSV()" class="btn btn-csv">üì• Baixar CSV</button>
            <button onclick="limparLista()" class="btn btn-clear">üóëÔ∏è Limpar</button>
        </div>
    </div>

    <ul id="result-list"></ul>

    <script>
        // CONFIGURA√á√ÉO: Apenas EAN_13
        const formatsToSupport = [ Html5QrcodeSupportedFormats.EAN_13 ];
        const html5QrCode = new Html5Qrcode("reader");
        
        let estoque = {}; 
        let currentTrack = null; // Para controlar a c√¢mera ativa

        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 150 }, // Ret√¢ngulo mais achatado para c√≥digo de barras
            formatsToSupport: formatsToSupport 
        };

        document.getElementById('start-btn').addEventListener('click', () => {
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    const cameraId = devices.length > 1 ? devices[1].id : devices[0].id;
                    
                    // Configura√ß√£o inicial da c√¢mera
                    const cameraConfig = { 
                        deviceId: cameraId,
                        // Tenta iniciar com foco cont√≠nuo por padr√£o
                        advanced: [{ focusMode: "continuous" }] 
                    };

                    html5QrCode.start(
                        cameraConfig, 
                        config, 
                        onScanSuccess
                    ).then(() => {
                        toggleButtons(true);
                        capturarTrackDaCamera();
                    });
                } else {
                    alert("C√¢mera n√£o encontrada.");
                }
            }).catch(err => alert("Erro: " + err));
        });

        // Fun√ß√£o para pegar o controle da c√¢mera (track) e habilitar o menu de foco
        function capturarTrackDaCamera() {
            try {
                // Tenta obter o stream de v√≠deo ativo
                currentTrack = html5QrCode.getRunningTrack();
                const capabilities = currentTrack.getCapabilities();

                // Verifica se a c√¢mera suporta mudan√ßa de foco
                if (capabilities.focusMode && capabilities.focusMode.length > 0) {
                    // Mostra o menu de foco apenas se suportado
                    document.getElementById('focus-panel').style.display = 'flex';
                    
                    // Atualiza o select com o que a c√¢mera realmente suporta (opcional, mas evita erros)
                    // Aqui mantemos as op√ß√µes padr√£o, mas o navegador pode ignorar se n√£o suportar.
                }
            } catch (e) {
                console.log("C√¢mera n√£o suporta ajustes avan√ßados.", e);
            }
        }

        // Fun√ß√£o chamada quando o usu√°rio muda o select
        async function mudarFoco() {
            if (!currentTrack) return;
            
            const mode = document.getElementById('focusMode').value;
            
            try {
                await currentTrack.applyConstraints({
                    advanced: [{ focusMode: mode }]
                });
                console.log("Foco alterado para: " + mode);
            } catch (err) {
                console.warn("N√£o foi poss√≠vel aplicar o foco: " + mode, err);
                alert("Esta c√¢mera n√£o suporta o modo: " + mode);
            }
        }

        document.getElementById('stop-btn').addEventListener('click', () => {
            html5QrCode.stop().then(() => {
                toggleButtons(false);
                document.getElementById('focus-panel').style.display = 'none';
            });
        });

        function toggleButtons(scanning) {
            document.getElementById('start-btn').style.display = scanning ? 'none' : 'inline-block';
            document.getElementById('stop-btn').style.display = scanning ? 'inline-block' : 'none';
        }

        function onScanSuccess(decodedText, decodedResult) {
            // Verifica duplicidade E se o formato √© realmente EAN_13 (redund√¢ncia de seguran√ßa)
            if (decodedResult.result.format && decodedResult.result.format.formatName !== "EAN_13") {
                console.log("Ignorado formato: " + decodedResult.result.format.formatName);
                return;
            }

            html5QrCode.pause(); 
            const dataHora = new Date().toLocaleTimeString('pt-BR');

            if (estoque[decodedText]) {
                estoque[decodedText].qtd += 1;
                estoque[decodedText].lastTime = dataHora;
                atualizarVisualRow(decodedText, true);
            } else {
                estoque[decodedText] = { qtd: 1, lastTime: dataHora };
                adicionarVisualRow(decodedText);
            }

            atualizarTotais();
            setTimeout(() => html5QrCode.resume(), 600); // Retoma r√°pido
        }

        function adicionarVisualRow(codigo) {
            const list = document.getElementById('result-list');
            const li = document.createElement('li');
            li.className = 'item-row';
            li.id = 'row-' + codigo;
            
            li.innerHTML = `
                <div class="code-info">
                    <span class="code-text">${codigo}</span>
                    <span class="code-time">${estoque[codigo].lastTime}</span>
                </div>
                <div class="qty-badge" id="qty-${codigo}">1</div>
            `;
            list.prepend(li);
        }

        function atualizarVisualRow(codigo, highlight) {
            document.getElementById(`qty-${codigo}`).innerText = estoque[codigo].qtd;
            document.getElementById(`time-${codigo}`).innerText = estoque[codigo].lastTime;

            if(highlight) {
                const row = document.getElementById(`row-${codigo}`);
                row.classList.remove('updated');
                void row.offsetWidth; 
                row.classList.add('updated');
                document.getElementById('result-list').prepend(row);
            }
        }

        function atualizarTotais() {
            document.getElementById('count-unique').innerText = Object.keys(estoque).length;
            document.getElementById('count-total').innerText = Object.values(estoque).reduce((a, b) => a + b.qtd, 0);
        }

        function limparLista() {
            if(confirm("Limpar toda a lista?")) {
                estoque = {};
                document.getElementById('result-list').innerHTML = '';
                atualizarTotais();
            }
        }

        function baixarCSV() {
            if (Object.keys(estoque).length === 0) { alert("Lista vazia!"); return; }
            let csv = "data:text/csv;charset=utf-8,Codigo;Quantidade;Hora\n";
            for (const [c, d] of Object.entries(estoque)) csv += `${c};${d.qtd};${d.lastTime}\n`;
            
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csv));
            link.setAttribute("download", `EAN13_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
